<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
    <meta name="color-scheme" content="light only"/>
    <title>预约看房 - Easy Aussie</title>
    <meta name="description" content="预约专业代看房服务，远程了解真实房屋情况"/>
    <script type="module" src="/src/main.ts"></script>
    <link rel="stylesheet" href="/src/styles/main.css"/>
    <script type="module">
        import { MobileHeaderComponent } from '/src/components/mobile-header.ts';
        import { MobileFooterComponent } from '/src/components/mobile-footer.ts';
        import { FormComponent } from '/src/components/form.ts';
        import { notificationService } from '/src/services/notification-service.ts';
        import { httpClient } from '/src/services/http-client.ts';
        import { authStore } from '/src/stores/auth-store.ts';

        document.addEventListener('DOMContentLoaded', () => {
            new MobileHeaderComponent();
            new MobileFooterComponent();
            
            // 检查登录状态，为用户提供登录提示
            checkAuthenticationStatus();
            
            initInspectionForm();
            initMobileFeatures();
            
            // 监听页面可见性变化，检查登录状态
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    // 页面变为可见时，重新检查登录状态
                    setTimeout(checkAuthenticationStatus, 500);
                }
            });
        });

        function checkAuthenticationStatus() {
            // 如果用户未登录，显示友好提示
            if (!authStore.isAuthenticated()) {
                setTimeout(() => {
                    // 检查是否是从登录页面跳转回来的
                    const urlParams = new URLSearchParams(window.location.search);
                    const fromLogin = urlParams.get('from') === 'login';
                    
                    if (!fromLogin) {
                        notificationService.info('提示：提交预约需要先登录账户', {
                            duration: 5000,
                            actions: [
                                {
                                    label: '现在登录',
                                    action: () => {
                                        const currentPath = encodeURIComponent(window.location.pathname + window.location.search);
                                        window.location.href = `/pages/auth/login.html?return=${currentPath}`;
                                    },
                                    primary: true
                                }
                            ]
                        });
                    }
                }, 2000); // 延迟2秒显示，给用户时间浏览页面
            }
        }

        function initInspectionForm() {
            const formContainer = document.getElementById('inspection-form');
            
            const form = new FormComponent(formContainer, {
                fields: [
                    {
                        name: 'wxid',
                        type: 'text',
                        label: '微信名称',
                        placeholder: '请输入您的微信名称',
                        required: true
                    },
                    {
                        name: 'name',
                        type: 'text',
                        label: '预约姓名',
                        placeholder: 'Full Name, 不确定可检查预约邮件抬头',
                        required: true
                    },
                    {
                        name: 'address',
                        type: 'text',
                        label: '房产地址',
                        placeholder: '例如: 35 Stirling Hwy, Crawley WA 6009',
                        required: true
                    },
                    {
                        name: 'appointmentDate',
                        type: 'datetime-local',
                        label: '预约时间',
                        required: true
                    },
                    {
                        name: 'email',
                        type: 'email',
                        label: '预约邮箱',
                        placeholder: '请输入预约时使用的邮箱',
                        required: true
                    },
                    {
                        name: 'phone',
                        type: 'tel',
                        label: '联系电话',
                        placeholder: '请输入您的联系电话'
                    }
                ],
                autoSave: false // 关闭原有的自动保存，改用自定义缓存逻辑
            });

            // 禁用FormComponent的默认提交处理，改用自定义处理
            setTimeout(() => {
                const formElement = formContainer.querySelector('form');
                if (formElement) {
                    // 移除FormComponent的提交事件监听器
                    const newForm = formElement.cloneNode(true);
                    formElement.parentNode?.replaceChild(newForm, formElement);
                    
                    // 添加我们自己的提交处理
                    newForm.addEventListener('submit', handleCustomSubmit);
                }
                
                // 在表单创建后添加自定义的检查清单组件
                addChecklistComponent();
                // 初始化数据缓存逻辑
                initFormCache();
                // 设置表单输入监听，用于自动保存
                setupFormAutoSave();
            }, 150);
        }

        async function handleCustomSubmit(e) {
            e.preventDefault();
            
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;

            // 检查用户是否已登录
            if (!authStore.isAuthenticated()) {
                notificationService.error('请先登录后再提交预约', {
                    actions: [
                        {
                            label: '去登录',
                            action: () => {
                                const currentPath = encodeURIComponent(window.location.pathname + window.location.search);
                                window.location.href = `/pages/auth/login.html?return=${currentPath}`;
                            },
                            primary: true
                        }
                    ]
                });
                return;
            }

            let loadingId = null;
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = '提交中...';
                
                loadingId = notificationService.loading('正在提交预约...');
                
                // 获取表单数据
                const formData = new FormData(form);
                
                // 获取检查清单数据
                const checklistItems = getChecklistData();
                
                // 添加检查清单，使用后端期望的格式 checklist[]
                checklistItems.forEach(item => {
                    if (item.trim()) {
                        formData.append('checklist[]', item);
                    }
                });
                
                // 添加表单类型
                formData.append('formType', 'inspection');

                const result = await httpClient.post('/api/form-submit', formData);
                
                // 关闭加载通知
                if (loadingId) {
                    notificationService.remove(loadingId);
                }
                
                if (result.success) {
                    notificationService.success('预约提交成功！我们会尽快与您联系。');
                    
                    // 提交成功，清除本地缓存
                    clearFormCache();
                    
                    setTimeout(() => {
                        window.location.href = '/pages/submit-success.html';
                    }, 2000);
                } else {
                    throw new Error(result.message || '提交失败');
                }
            } catch (error) {
                // 关闭加载通知
                if (loadingId) {
                    notificationService.remove(loadingId);
                }
                
                // 如果是认证错误，提供更明确的提示
                if (error.status === 401 || error.status === 403) {
                    notificationService.error('登录已过期，请重新登录', {
                        actions: [
                            {
                                label: '重新登录',
                                action: () => {
                                    const currentPath = encodeURIComponent(window.location.pathname + window.location.search);
                                    window.location.href = `/pages/auth/login.html?return=${currentPath}`;
                                },
                                primary: true
                            }
                        ]
                    });
                } else {
                    notificationService.error('提交失败，请重试或联系客服');
                }
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        // ================== 表单缓存相关功能 ==================
        
        function initFormCache() {
            // 1. 优先检查本地缓存
            const localCache = loadFormFromCache();
            if (localCache) {
                fillFormWithData(localCache);
                return;
            }
            
            // 2. 本地没有缓存，从后台获取最新数据
            loadLatestFormFromServer();
        }
        
        function loadFormFromCache() {
            try {
                const cached = localStorage.getItem('ea-inspection-form-cache');
                if (cached) {
                    return JSON.parse(cached);
                }
            } catch (error) {
                localStorage.removeItem('ea-inspection-form-cache');
            }
            return null;
        }
        
        async function loadLatestFormFromServer() {
            try {
                const currentUser = authStore.getCurrentUser();
                if (!currentUser || !authStore.isAuthenticated()) {
                    return;
                }
                
                const response = await httpClient.get('/api/form-latest?type=inspection');
                
                // httpClient返回的格式是 { data: { data: "...", status: "success" }, success: true }
                if (response.success && response.data && response.data.status === 'success' && response.data.data !== null && response.data.data !== undefined) {
                    // 解析JSON字符串格式的数据
                    let parsedData;
                    if (typeof response.data.data === 'string') {
                        try {
                            parsedData = JSON.parse(response.data.data);
                        } catch (parseError) {
                            return;
                        }
                    } else {
                        parsedData = response.data.data;
                    }
                    
                    // 从后台获取的数据不保留房产地址和预约时间
                    const filteredData = { ...parsedData };
                    delete filteredData.address;
                    delete filteredData.appointmentDate;
                    
                    // 处理检查清单数据
                    if (parsedData['checklist[]'] && Array.isArray(parsedData['checklist[]'])) {
                        filteredData.checklist = parsedData['checklist[]'];
                    }
                    
                    // 清理不需要的字段
                    delete filteredData['checklist[]'];
                    delete filteredData['checklist-item'];
                    
                    // 保存到本地缓存
                    saveFormToCache(filteredData);
                    
                    // 填充表单（不包括地址和预约时间）
                    fillFormWithData(filteredData);
                }
            } catch (error) {
                // 静默处理错误
            }
        }
        
        function fillFormWithData(data) {
            if (!data || typeof data !== 'object') return;
            
            // 等待表单元素加载完成
            setTimeout(() => {
                // 填充基本字段
                Object.keys(data).forEach(key => {
                    if (key === 'checklist') return; // 检查清单单独处理
                    
                    const input = document.querySelector(`input[name="${key}"], textarea[name="${key}"], select[name="${key}"]`);
                    if (input && data[key] !== undefined && data[key] !== null && data[key] !== '') {
                        input.value = data[key];
                        
                        // 触发input事件以更新组件状态
                        input.dispatchEvent(new Event('input', { bubbles: true }));
                        input.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                });
                
                // 恢复检查清单数据
                if (data.checklist && Array.isArray(data.checklist)) {
                    restoreChecklistFromData(data.checklist);
                }
            }, 300); // 给表单组件更多时间完成初始化
        }
        
        function saveFormToCache(data) {
            try {
                localStorage.setItem('ea-inspection-form-cache', JSON.stringify(data));
            } catch (error) {
                // 静默处理存储错误
            }
        }
        
        function clearFormCache() {
            localStorage.removeItem('ea-inspection-form-cache');
            localStorage.removeItem('ea-form-checklist'); // 也清除检查清单缓存
        }
        
        function getCurrentFormData() {
            const formData = {};
            
            // 获取所有表单字段
            const inputs = document.querySelectorAll('#inspection-form input, #inspection-form textarea, #inspection-form select');
            inputs.forEach(input => {
                if (input.name && input.name !== 'checklist-item') {
                    formData[input.name] = input.value;
                }
            });
            
            // 获取检查清单数据
            const checklistData = getChecklistData();
            if (checklistData.length > 0) {
                formData.checklist = checklistData;
            }
            
            return formData;
        }
        
        function setupFormAutoSave() {
            // 监听表单输入变化，自动保存到缓存
            const container = document.getElementById('inspection-form');
            if (!container) return;
            
            let saveTimeout;
            
            const autoSave = () => {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    const formData = getCurrentFormData();
                    saveFormToCache(formData);
                }, 1000); // 1秒后保存
            };
            
            // 监听所有输入字段
            container.addEventListener('input', autoSave);
            container.addEventListener('change', autoSave);
        }
        
        function restoreChecklistFromData(checklistData) {
            if (!Array.isArray(checklistData) || checklistData.length === 0) return;
            
            setTimeout(() => {
                const container = document.getElementById('checklist-container');
                if (!container) {
                    setTimeout(() => restoreChecklistFromData(checklistData), 500);
                    return;
                }
                
                // 清空现有项目
                container.innerHTML = '';
                
                // 添加保存的项目
                checklistData.forEach((item, index) => {
                    const isFirst = index === 0;
                    const newItemHtml = `
                        <div class="ea-checklist-item">
                            <input 
                                type="text" 
                                class="ea-input ea-checklist-input" 
                                placeholder="请输入需要重点检查的事项"
                                maxlength="50"
                                name="checklist-item"
                                value="${item.replace(/"/g, '&quot;')}"
                            />
                            <button type="button" class="ea-checklist-remove ${isFirst && checklistData.length === 1 ? 'hidden' : ''}">
                                删除
                            </button>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', newItemHtml);
                });
                
                // 如果没有项目，至少添加一个空项目
                if (checklistData.length === 0) {
                    const defaultItemHtml = `
                        <div class="ea-checklist-item">
                            <input 
                                type="text" 
                                class="ea-input ea-checklist-input" 
                                placeholder="请输入需要重点检查的事项"
                                maxlength="50"
                                name="checklist-item"
                            />
                            <button type="button" class="ea-checklist-remove hidden">
                                删除
                            </button>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', defaultItemHtml);
                }
                
                updateRemoveButtons();
                updateAddButton();
                
                // 重新绑定检查清单事件（因为重新生成了HTML）
                bindChecklistEvents();
            }, 400); // 增加延迟确保容器已创建
        }
        

        function addChecklistComponent() {
            const form = document.querySelector('#inspection-form form');
            if (!form) return;

            // 在提交按钮前插入检查清单组件
            const submitContainer = form.querySelector('.flex.gap-4.pt-4');
            if (!submitContainer) return;

            const checklistHtml = `
                <div class="ea-field">
                    <label class="ea-label">
                        重点检查事项
                    </label>
                    <div id="checklist-container" class="ea-checklist">
                        <div class="ea-checklist-item">
                            <input 
                                type="text" 
                                class="ea-input ea-checklist-input" 
                                placeholder="请输入需要重点检查的事项"
                                maxlength="50"
                                name="checklist-item"
                            />
                            <button type="button" class="ea-checklist-remove hidden">
                                删除
                            </button>
                        </div>
                    </div>
                    <div class="ea-checklist-footer">
                        <button type="button" id="add-checklist-item" class="ea-checklist-add">
                            <i class="fas fa-plus"></i>添加检查项
                        </button>
                        <span class="ea-checklist-hint">最多5项，每项50字符</span>
                    </div>
                </div>
            `;

            submitContainer.insertAdjacentHTML('beforebegin', checklistHtml);
            
            // 绑定检查清单事件
            bindChecklistEvents();
        }

        function bindChecklistEvents() {
            const container = document.getElementById('checklist-container');
            const addBtn = document.getElementById('add-checklist-item');
            
            if (!container || !addBtn) return;

            // 添加检查项
            addBtn.addEventListener('click', () => {
                const items = container.querySelectorAll('.ea-checklist-item');
                if (items.length >= 5) {
                    notificationService.warning('最多只能添加5个检查项');
                    return;
                }

                const newItemHtml = `
                    <div class="ea-checklist-item">
                        <input 
                            type="text" 
                            class="ea-input ea-checklist-input" 
                            placeholder="请输入需要重点检查的事项"
                            maxlength="50"
                            name="checklist-item"
                        />
                        <button type="button" class="ea-checklist-remove">
                            删除
                        </button>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', newItemHtml);
                updateRemoveButtons();
                updateAddButton();
                // 触发表单自动保存
                const formData = getCurrentFormData();
                saveFormToCache(formData);
            });

            // 删除检查项（事件委托）
            container.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.ea-checklist-remove');
                if (removeBtn) {
                    const item = removeBtn.closest('.ea-checklist-item');
                    if (item) {
                        item.remove();
                        updateRemoveButtons();
                        updateAddButton();
                        // 触发表单自动保存
                        const formData = getCurrentFormData();
                        saveFormToCache(formData);
                    }
                }
            });

            // 字符计数和自动保存
            container.addEventListener('input', (e) => {
                const input = e.target;
                if (input.name === 'checklist-item') {
                    // 触发表单自动保存
                    const formData = getCurrentFormData();
                    saveFormToCache(formData);
                }
            });

            updateRemoveButtons();
        }

        function saveChecklistData() {
            // 这个函数保留用于兼容性，但功能已整合到统一缓存系统
            const formData = getCurrentFormData();
            saveFormToCache(formData);
        }

        function restoreChecklistData() {
            // 兼容性函数，实际恢复逻辑在 initFormCache 中处理
        }

        function updateRemoveButtons() {
            const container = document.getElementById('checklist-container');
            if (!container) return;

            const items = container.querySelectorAll('.ea-checklist-item');
            const removeButtons = container.querySelectorAll('.ea-checklist-remove');

            // 只有一个项目时隐藏删除按钮
            if (items.length <= 1) {
                removeButtons.forEach(btn => btn.classList.add('hidden'));
            } else {
                removeButtons.forEach(btn => btn.classList.remove('hidden'));
            }
        }

        function updateAddButton() {
            const container = document.getElementById('checklist-container');
            const addBtn = document.getElementById('add-checklist-item');
            
            if (!container || !addBtn) return;

            const items = container.querySelectorAll('.ea-checklist-item');
            
            if (items.length >= 5) {
                addBtn.disabled = true;
                addBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                addBtn.disabled = false;
                addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function getChecklistData() {
            const container = document.getElementById('checklist-container');
            if (!container) return [];

            const inputs = container.querySelectorAll('input[name="checklist-item"]');
            const items = [];
            
            inputs.forEach(input => {
                const value = input.value.trim();
                if (value) {
                    items.push(value);
                }
            });
            
            return items;
        }

        function initMobileFeatures() {
            // 延迟自动填充预约时间，确保缓存系统优先级更高
            setTimeout(() => {
                const appointmentInput = document.querySelector('input[name="appointmentDate"]');
                if (appointmentInput && !appointmentInput.value) {
                    // 只有在没有值时才自动填充（避免覆盖缓存数据）
                    const now = new Date();
                    now.setHours(now.getHours() + 1);
                    appointmentInput.value = now.toISOString().slice(0, 16);
                }
            }, 1000); // 延迟1秒，确保缓存恢复完成

            // 添加地址自动完成（模拟）
            const addressInput = document.querySelector('input[name="address"]');
            if (addressInput) {
                const commonAddresses = [
                    'Stirling Hwy, Crawley WA',
                    'Hay Street, Perth WA',
                    'Murray Street, Perth WA',
                    'Adelaide Terrace, East Perth WA',
                    'Great Eastern Hwy, Belmont WA'
                ];

                addressInput.addEventListener('input', (e) => {
                    const value = e.target.value.toLowerCase();
                    if (value.length > 2) {
                        // 可以在这里添加地址自动完成功能
                    }
                });
            }
        }
    </script>
</head>

<body class="ea-service-page">
<div id="header"></div>

<main class="flex-grow">
    <!-- 页面头部 -->
    <div class="ea-service-header">
        <div class="ea-service-header-content">
            <div class="ea-service-header-layout">
                <div>
                    <h1 class="ea-service-title">预约看房服务</h1>
                    <p class="ea-service-subtitle">专业团队代您实地看房，详细反馈房屋情况</p>
                </div>
                <div class="ea-service-price ea-service-price-desktop">
                    <div class="ea-service-price-amount">$25</div>
                    <div class="ea-service-price-label">起</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 服务特色 -->
    <div class="ea-service-features">
        <div class="ea-feature-grid">
            <div class="ea-feature-item">
                <div class="ea-feature-icon ea-feature-icon--blue">
                    <i class="fas fa-video"></i>
                </div>
                <div class="ea-feature-content">
                    <div class="ea-feature-title">高清视频</div>
                    <div class="ea-feature-description">详细拍摄每个角落</div>
                </div>
            </div>
            <div class="ea-feature-item">
                <div class="ea-feature-icon ea-feature-icon--green">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="ea-feature-content">
                    <div class="ea-feature-title">24小时反馈</div>
                    <div class="ea-feature-description">快速提供看房报告</div>
                </div>
            </div>
            <div class="ea-feature-item">
                <div class="ea-feature-icon ea-feature-icon--purple">
                    <i class="fas fa-star"></i>
                </div>
                <div class="ea-feature-content">
                    <div class="ea-feature-title">专业评价</div>
                    <div class="ea-feature-description">给出中肯建议</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 表单区域 -->
    <div class="ea-service-main">
        <div class="ea-service-container">
            <div class="ea-form-card">
                <div class="ea-form-card-header">
                    <h2 class="ea-form-card-title">填写预约信息</h2>
                    <p class="ea-form-card-description">请准确填写以下信息，我们会根据您的需求安排看房</p>
                </div>
                <div class="ea-form-card-content">
                    <div id="inspection-form"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 帮助区域 -->
    <div class="ea-help-section">
        <div class="ea-service-container">
            <div class="ea-help-card">
                <h3 class="ea-help-title">
                    <i class="fas fa-question-circle"></i>
                    常见问题
                </h3>
                <div class="ea-faq-list">
                    <div class="ea-faq-item">
                        <span class="ea-faq-q">Q:</span>
                        <div class="ea-faq-content">
                            <div class="ea-faq-question">看房报告包含什么内容？</div>
                            <p class="ea-faq-answer">包括高清视频、房屋状况评价、周边环境介绍、专业建议等。</p>
                        </div>
                    </div>
                    <div class="ea-faq-item">
                        <span class="ea-faq-q">Q:</span>
                        <div class="ea-faq-content">
                            <div class="ea-faq-question">如果看房时间与中介安排冲突怎么办？</div>
                            <p class="ea-faq-answer">我们会协调最佳时间，或建议备选方案。</p>
                        </div>
                    </div>
                    <div class="ea-faq-item">
                        <span class="ea-faq-q">Q:</span>
                        <div class="ea-faq-content">
                            <div class="ea-faq-question">费用什么时候支付？</div>
                            <p class="ea-faq-answer">看房完成并发送报告后再付款，确保服务质量。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<div id="footer"></div>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
</body>
</html>
