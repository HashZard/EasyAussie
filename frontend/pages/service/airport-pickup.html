<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
    <meta name="color-scheme" content="light only"/>
    <title>机场接机服务 - Easy Aussie</title>
    <meta name="description" content="预订专业的机场接机服务，安全舒适地到达目的地"/>
    <script type="module" src="/src/main.ts"></script>
    <link rel="stylesheet" href="/src/styles/main.css"/>
    <script type="module">
        import { MobileHeaderComponent } from '/src/components/mobile-header.ts';
        import { MobileFooterComponent } from '/src/components/mobile-footer.ts';
        import { FormComponent } from '/src/components/form.ts';
        import { notificationService } from '/src/services/notification-service.ts';
        import { httpClient } from '/src/services/http-client.ts';
        import { authStore } from '/src/stores/auth-store.ts';

        document.addEventListener('DOMContentLoaded', () => {
            new MobileHeaderComponent();
            new MobileFooterComponent();
            
            initAirportPickupForm();
            initMobileFeatures();
        });

        function initAirportPickupForm() {
            const formContainer = document.getElementById('airport-pickup-form');
            
            const form = new FormComponent(formContainer, {
                fields: [
                    {
                        name: 'wx_name',
                        type: 'text',
                        label: '微信名称',
                        placeholder: '请输入您的微信名称',
                        required: true
                    },
                    {
                        name: 'flight_number',
                        type: 'text',
                        label: '航班号',
                        placeholder: '如：CZ325',
                        required: true
                    },
                    {
                        name: 'pickup_time',
                        type: 'datetime-local',
                        label: '预计接机时间',
                        required: true
                    },
                    {
                        name: 'contact_phone',
                        type: 'tel',
                        label: '联系电话',
                        placeholder: '请输入您的联系电话',
                        required: true
                    },
                    {
                        name: 'destination',
                        type: 'text',
                        label: '目的地地址',
                        placeholder: '例如: 35 Stirling Hwy, Crawley WA 6009',
                        required: true
                    },
                    {
                        name: 'luggage_info',
                        type: 'text',
                        label: '行李数量及尺寸',
                        placeholder: '例：28寸箱子 ×2 个，24寸箱子 ×1 个'
                    }
                ],
                autoSave: true,
                onSubmit: async (data) => {
                    let loadingId = null;
                    try {
                        // 检查用户是否已登录
                        const currentUser = authStore.getCurrentUser();
                        const token = localStorage.getItem('auth_token');
                        
                        console.log('认证状态检查:', {
                            isAuthenticated: authStore.isAuthenticated(),
                            hasUser: !!currentUser,
                            hasToken: !!token,
                            userEmail: currentUser?.email,
                            tokenPreview: token ? token.substring(0, 20) + '...' : 'null'
                        });
                        
                        if (!authStore.isAuthenticated()) {
                            console.warn('用户未登录，无法提交表单');
                            notificationService.error('请先登录后再提交预约', {
                            });
                            return;
                        }
                        
                        loadingId = notificationService.loading('正在提交接机预约...');
                        
                        // 构建提交数据，格式与后端期望一致
                        const formData = new FormData();
                        
                        // 添加表单字段
                        for (const [key, value] of data.entries()) {
                            formData.append(key, value);
                        }
                        
                        // 获取备注信息
                        const noteTextarea = document.querySelector('textarea[name="note"]');
                        if (noteTextarea && noteTextarea.value.trim()) {
                            formData.append('note', noteTextarea.value.trim());
                        }
                        
                        // 添加表单类型
                        formData.append('formType', 'airportPickup');

                        const result = await httpClient.post('/api/form-submit', formData);
                        
                        // 关闭加载通知
                        if (loadingId) {
                            notificationService.remove(loadingId);
                        }
                        
                        if (result.success) {
                            notificationService.success('接机预约提交成功！我们会尽快与您联系。');
                            setTimeout(() => {
                                window.location.href = '/pages/submit-success.html';
                            }, 2000);
                        } else {
                            throw new Error(result.message || '提交失败');
                        }
                    } catch (error) {
                        // 关闭加载通知
                        if (loadingId) {
                            notificationService.remove(loadingId);
                        }
                        console.error('Submit error:', error);
                        
                        // 如果是认证错误，提供更明确的提示
                        if (error.status === 401 || error.status === 403) {
                            notificationService.error('登录已过期，请重新登录', {
                            });
                        } else {
                            notificationService.error('提交失败，请重试或联系客服');
                        }
                    }
                }
            });

            // 在表单创建后添加备注字段
            setTimeout(() => {
                addNoteField();
            }, 100);
        }

        function addNoteField() {
            const form = document.querySelector('#airport-pickup-form form');
            if (!form) return;

            // 在提交按钮前插入备注字段
            const submitContainer = form.querySelector('.flex.gap-4.pt-4');
            if (!submitContainer) return;

            const noteHtml = `
                <div class="ea-field">
                    <label class="ea-label">
                        备注
                    </label>
                    <textarea 
                        name="note" 
                        class="ea-input ea-textarea" 
                        placeholder="如有特殊要求请在此说明，如儿童安全座椅、轮椅通道等"
                        rows="3"
                    ></textarea>
                </div>
            `;

            submitContainer.insertAdjacentHTML('beforebegin', noteHtml);
        }

        function initMobileFeatures() {
            // 自动填充当前时间（2小时后，考虑航班到达时间）
            const pickupInput = document.querySelector('input[name="pickup_time"]');
            if (pickupInput) {
                const now = new Date();
                now.setHours(now.getHours() + 2);
                pickupInput.value = now.toISOString().slice(0, 16);
            }

            // 添加地址自动完成（模拟）
            const destinationInput = document.querySelector('input[name="destination"]');
            if (destinationInput) {
                const commonAddresses = [
                    'Perth Airport Terminal',
                    'Melbourne Airport Terminal',
                    'Sydney Airport Terminal',
                    'Brisbane Airport Terminal',
                    'Adelaide Airport Terminal'
                ];

                destinationInput.addEventListener('input', (e) => {
                    const value = e.target.value.toLowerCase();
                    if (value.length > 2) {
                        // 可以在这里添加地址自动完成功能
                    }
                });
            }

            // 防止移动端输入框聚焦时页面跳动
            const inputs = document.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                input.style.scrollMargin = '0';
                input.style.fontSize = '16px'; // 防止iOS缩放
            });

            // iOS Safari 特殊处理
            if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                inputs.forEach(input => {
                    input.style.transform = 'translateZ(0)';
                    input.style.webkitTransform = 'translateZ(0)';
                });
            }
        }
    </script>
</head>

<body class="ea-service-page">
<div id="header"></div>

<main class="flex-grow">
    <!-- 页面头部 -->
    <div class="ea-service-header">
        <div class="ea-service-header-content">
            <div class="ea-service-header-layout">
                <div>
                    <h1 class="ea-service-title">机场接机服务</h1>
                    <p class="ea-service-subtitle">专业司机，安全舒适，让您的澳洲之旅从温暖的接机开始</p>
                </div>
                <div class="ea-service-price ea-service-price-desktop">
                    <div class="ea-service-price-amount">$60</div>
                    <div class="ea-service-price-label">起</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 服务特色 -->
    <div class="ea-service-features">
        <div class="ea-feature-grid">
            <div class="ea-feature-item">
                <div class="ea-feature-icon ea-feature-icon--blue">
                    <i class="fas fa-car"></i>
                </div>
                <div class="ea-feature-content">
                    <div class="ea-feature-title">专业司机</div>
                    <div class="ea-feature-description">经验丰富，安全可靠</div>
                </div>
            </div>
            <div class="ea-feature-item">
                <div class="ea-feature-icon ea-feature-icon--green">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="ea-feature-content">
                    <div class="ea-feature-title">准时接机</div>
                    <div class="ea-feature-description">实时航班跟踪</div>
                </div>
            </div>
            <div class="ea-feature-item">
                <div class="ea-feature-icon ea-feature-icon--purple">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="ea-feature-content">
                    <div class="ea-feature-title">安全保障</div>
                    <div class="ea-feature-description">全程保险覆盖</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 表单区域 -->
    <div class="ea-service-main">
        <div class="ea-service-container">
            <div class="ea-form-card">
                <div class="ea-form-card-header">
                    <h2 class="ea-form-card-title">填写接机信息</h2>
                    <p class="ea-form-card-description">请准确填写以下信息，我们会安排最合适的接机服务</p>
                </div>
                <div class="ea-form-card-content">
                    <div id="airport-pickup-form"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 帮助区域 -->
    <div class="ea-help-section">
        <div class="ea-service-container">
            <div class="ea-help-card">
                <h3 class="ea-help-title">
                    <i class="fas fa-question-circle"></i>
                    常见问题
                </h3>
                <div class="ea-faq-list">
                    <div class="ea-faq-item">
                        <span class="ea-faq-q">Q:</span>
                        <div class="ea-faq-content">
                            <div class="ea-faq-question">接机服务包含什么？</div>
                            <p class="ea-faq-answer">包括机场迎接、行李协助、安全送达目的地等全程服务。</p>
                        </div>
                    </div>
                    <div class="ea-faq-item">
                        <span class="ea-faq-q">Q:</span>
                        <div class="ea-faq-content">
                            <div class="ea-faq-question">如果航班延误怎么办？</div>
                            <p class="ea-faq-answer">我们会实时跟踪航班动态，根据最新到达时间调整接机安排。</p>
                        </div>
                    </div>
                    <div class="ea-faq-item">
                        <span class="ea-faq-q">Q:</span>
                        <div class="ea-faq-content">
                            <div class="ea-faq-question">费用如何计算？</div>
                            <p class="ea-faq-answer">根据接机距离、时间段、车型等因素综合计算，提前确认价格。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<div id="footer"></div>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
</body>
</html>
